<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../url-method-selector/url-method-selector.html">

<dom-module id="service-panel">
  <template>
    <style include="shared-styles">
    </style>
    <label>Type</label>
    <div>[[type]]</div>
    <paper-icon-button icon="list" title="heart" style="float:right; margin-top: -16px;"></paper-icon-button>
    <label>Configuration</label>
    <juicy-jsoneditor id="params" mode="tree" modes=["view","tree","text","form"] json="{{params}}"></juicy-jsoneditor>
    [[errors]]
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'service-panel',
        updateParams: function() {
          // Not optimal
          var newService = {};
          for (let i in this.params) {
            newService[i] = this.params[i];
            this.component[i] = this.params[i];
          }
          for (let i in this.component) {
            if (i == "require" || i == "type") {
              continue;
            }
            if (i.startsWith('_')) continue;
            if (newService[i] === undefined) {
              delete this.component[i];
            }
          }
          this.validate();
        },
        validate: function() {
          var type = this.component.type;
          if (type === undefined) {
            type = this.component._name;
          }
          if (type.indexOf('/') == -1) {
            type = "Webda/" + type;
          }
          if (app.hasSchema(type)) {
            this.toggleClass('unknown', false, this.$.params);
            if (app.ajv.validate(type, app.getRealConfiguration(this.component))) {
              this.errors = undefined;
              this.toggleClass('invalid', false, this.$.params);
            } else {
              this.errors = 'Configuration' + app.ajv.errorsText().substr(4);
              this.toggleClass('invalid', true, this.$.params);
            }
          } else {
              this.toggleClass('unknown', true, this.$.params);
              this.toggleClass('invalid', false, this.$.params);
              this.errors = undefined;
          }
        },
        filterComponent: function () {
          // As configuration is include in the definition need to filter _type and _name
          this.params = {};
          this.type = undefined;
          for (let i in this.component) {
            if (i.startsWith('_')) {
              continue;
            }
            if (i == "type") {
              this.type = this.component[i];
              continue;
            }
            if (i == "require") {
              this.type = "Custom";
              continue;
            }
            this.params[i] = this.component[i];
          }
          if (this.type === undefined && this.component) {
            this.type = this.component._name;
          }
          this.validate()
        },
        ready: function() {
          this.timeout;
          this.$.params.addEventListener('change', (evt) => {
            // Change is emit before the change, and not other event is emitted
            // For now using timeout to recompute the info
            // Not nice
            var timeout = () => {
              this.updateParams();
            };
            if (this.timeout) {
              clearTimeout(this.timeout);
            }
            this.timeout = setTimeout(timeout, 100);
          });
        },
        properties: {
          dirty: {
            type: Boolean,
            value: false,
            readonly: true
          },
          component: {
            type: Object,
            notify: true,
            observer: 'filterComponent'
          }
        }
      });
    })();
  </script>
</dom-module>
